<script>
import mpx, { createApp } from '@mpxjs/core'
import apiProxy from '@mpxjs/api-proxy'
import store from './store'
import { getCommonConfig, getCurrentRole } from '@/api'
import setting from './setting/setting'

mpx.use(apiProxy, { usePromise: true })

createApp({
  ...store.mapMutations(['initNavBarStyle', 'setState']),
  async onLaunch() {
    this.initNavBarStyle()
    wx.cloud.init({
      env: setting.CLOUD_ID,
      traceUser: true
    })
    this.setState({
      appReady: false
    })
    const [constant, roleInfo] = await Promise.all([getCommonConfig(), getCurrentRole()])
    const { categoryItems, steps, roles } = constant.data
    const { role = '', address = [], OPENID } = roleInfo.data
    let obj = {
      categoryItems,
      steps,
      footerNavBar: roles,
      appReady: true
    }
    if (address.length) {
      Object.assign(obj, {
        addressList: address
      })
    }
    if (role) {
      Object.assign(obj, { role })
    }
    if (OPENID) {
      Object.assign(obj, {
        openid: OPENID
      })
    }
    this.setState(obj)
  },
  globalStore: store,
  onShareAppMessage() {
    return {
      path: '/pages/page'
    }
  }
})
</script>

<script type="application/json">
  {
    "pages": [
      "./pages/page",
      "./pages/webview"
    ],
    "packages": [
      "./subpackages/homepage/app?root=homepage",
      "./subpackages/order-detail/app?root=order-detail",
      "./subpackages/choose-role/app?root=choose-role",
      "./subpackages/address-manager/app?root=address-manager",
      "./subpackages/manager/app?root=manager",
      "./subpackages/release/app?root=release",
      "./subpackages/company/app?root=company"
    ],
    "window": {
      "navigationStyle": "custom",
      "disableScroll": true
    },
    "requiredPrivateInfos": [
      "chooseAddress",
      "choosePoi",
      "chooseLocation",
      "getLocation"
    ],
    "permission": {
      "scope.userLocation": {
        "desc": "你的位置信息将用于小程序位置接口的效果展示"
      }
    }
  }
</script>
